<!-- REPAIRS -->
<section id="repairs">
  <h1>Repair Requests</h1>
  <form id="repairForm">
    <input type="hidden" id="repairId"> <!-- used when editing -->
    <input type="text" id="repairDetails" placeholder="Details" required>
    <input type="datetime-local" id="repairDate" required>
    <select id="repairStatus">
      <option>Not Started</option>
      <option>In Progress</option>
      <option>Complete</option>
    </select>
    <input type="file" id="repairFiles" multiple accept=".pdf,.jpg,.jpeg,.png">
    <button type="submit">Save Repair Request</button>
  </form>
  <ul id="repairList"></ul>
</section>

<script>
  function saveData(key, obj, id=null) {
    let data = JSON.parse(localStorage.getItem(key)) || [];
    if (id !== null) {
      // Update existing
      data[id] = obj;
    } else {
      data.push(obj);
    }
    localStorage.setItem(key, JSON.stringify(data));
    renderList(key);
    updateDashboard();
  }

  function renderList(key) {
    const listId = key + "List";
    const list = document.getElementById(listId);
    if (!list) return;
    list.innerHTML = "";
    let data = JSON.parse(localStorage.getItem(key)) || [];
    data.forEach((item, idx) => {
      const li = document.createElement("li");
      let fileLinks = "";
      if (item.files && item.files.length) {
        fileLinks = item.files.map(f => {
          if (f.type.startsWith("image/")) {
            return `<br><img src="${f.data}" alt="${f.name}" style="max-width:100px; margin-top:5px;">`;
          } else {
            return `<br><a href="${f.data}" download="${f.name}">${f.name}</a>`;
          }
        }).join("");
      }
      li.innerHTML = `
        <strong>${item.details}</strong> | ${item.date} | ${item.status}
        ${fileLinks}
        <br><button onclick="editRepair(${idx})">Edit</button>
      `;
      list.appendChild(li);
    });
  }

  document.getElementById("repairForm").onsubmit = async e => {
    e.preventDefault();

    const files = [];
    for (let file of repairFiles.files) {
      const reader = new FileReader();
      await new Promise(res => {
        reader.onload = () => {
          files.push({ name: file.name, type: file.type, data: reader.result });
          res();
        };
        reader.readAsDataURL(file);
      });
    }

    const id = repairId.value ? parseInt(repairId.value) : null;
    saveData("repair", {
      details: repairDetails.value,
      date: repairDate.value,
      status: repairStatus.value,
      files: files
    }, id);

    e.target.reset();
    repairId.value = "";
  };

  function editRepair(index) {
    let data = JSON.parse(localStorage.getItem("repair")) || [];
    const r = data[index];
    repairId.value = index;
    repairDetails.value = r.details;
    repairDate.value = r.date;
    repairStatus.value = r.status;
    // Note: cannot auto-fill file input for security, user must reselect if needed
  }
</script>
